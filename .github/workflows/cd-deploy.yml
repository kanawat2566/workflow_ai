name: CD — Build & Push Docker Images

on:
  push:
    branches: [main]   # deploy เฉพาะ merge to main
  workflow_dispatch:   # trigger manually ได้

env:
  REGISTRY: ghcr.io                          # GitHub Container Registry (ฟรี)
  IMAGE_PREFIX: ${{ github.repository }}     # e.g. yourname/bot_ai

jobs:
  detect-changes:
    name: Detect changed services
    runs-on: ubuntu-latest
    outputs:
      parser-dotnet: ${{ steps.filter.outputs.parser-dotnet }}
      gateway:       ${{ steps.filter.outputs.gateway }}
      orchestrator:  ${{ steps.filter.outputs.orchestrator }}
      rag:           ${{ steps.filter.outputs.rag }}
      memory:        ${{ steps.filter.outputs.memory }}
      executor:      ${{ steps.filter.outputs.executor }}
      evaluator:     ${{ steps.filter.outputs.evaluator }}
      telegram-bot:  ${{ steps.filter.outputs.telegram-bot }}
      worker:        ${{ steps.filter.outputs.worker }}
      frontend:      ${{ steps.filter.outputs.frontend }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2   # need previous commit to detect changes

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            parser-dotnet:
              - 'services/parser-dotnet/**'
              - 'infra/docker/dotnet.Dockerfile'
            gateway:
              - 'services/gateway/**'
              - 'infra/docker/python.Dockerfile'
            orchestrator:
              - 'services/orchestrator/**'
              - 'shared/contracts/**'
            rag:
              - 'services/rag/**'
              - 'shared/contracts/**'
            memory:
              - 'services/memory/**'
            executor:
              - 'services/executor/**'
              - 'shared/templates/**'
            evaluator:
              - 'services/evaluator/**'
            telegram-bot:
              - 'services/telegram-bot/**'
            worker:
              - 'services/worker/**'
            frontend:
              - 'frontend/**'
              - 'infra/docker/nextjs.Dockerfile'

  # ─── Build & Push per service ───────────────────────────
  build-push:
    name: Build & Push — ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs[matrix.service] == 'true' ||
      github.event_name == 'workflow_dispatch'

    permissions:
      contents: read
      packages: write   # ต้องการสำหรับ ghcr.io

    strategy:
      fail-fast: false
      matrix:
        include:
          - service: parser-dotnet
            context: services/parser-dotnet
            dockerfile: infra/docker/dotnet.Dockerfile
          - service: gateway
            context: services/gateway
            dockerfile: infra/docker/python.Dockerfile
          - service: orchestrator
            context: services/orchestrator
            dockerfile: infra/docker/python.Dockerfile
          - service: rag
            context: services/rag
            dockerfile: infra/docker/python.Dockerfile
          - service: memory
            context: services/memory
            dockerfile: infra/docker/python.Dockerfile
          - service: executor
            context: services/executor
            dockerfile: infra/docker/python.Dockerfile
          - service: evaluator
            context: services/evaluator
            dockerfile: infra/docker/python.Dockerfile
          - service: telegram-bot
            context: services/telegram-bot
            dockerfile: infra/docker/python.Dockerfile
          - service: worker
            context: services/worker
            dockerfile: infra/docker/python.Dockerfile
          - service: frontend
            context: frontend
            dockerfile: infra/docker/nextjs.Dockerfile

    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}
          tags: |
            type=sha,prefix=sha-
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=ref,event=branch

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}

  # ─── Deploy (self-hosted server via SSH) ────────────────
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build-push
    environment: production   # ต้องกด approve ใน GitHub ก่อน deploy

    steps:
      - uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd /opt/bot_ai
            git pull origin main
            docker compose pull
            docker compose up -d --remove-orphans
            docker system prune -f
            echo "Deployed: $(date)"
