name: CI — Python Services

on:
  push:
    branches: [main, develop, "feat/**"]
    paths:
      - "services/gateway/**"
      - "services/orchestrator/**"
      - "services/rag/**"
      - "services/memory/**"
      - "services/executor/**"
      - "services/evaluator/**"
      - "services/telegram-bot/**"
      - "services/worker/**"
      - "shared/contracts/**"
      - "pyproject.toml"
      - ".github/workflows/ci-python-services.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "services/gateway/**"
      - "services/orchestrator/**"
      - "services/rag/**"
      - "services/memory/**"
      - "services/executor/**"
      - "services/evaluator/**"
      - "services/telegram-bot/**"
      - "services/worker/**"
      - "shared/contracts/**"

jobs:
  detect-changes:
    name: Detect changed services
    runs-on: ubuntu-latest
    outputs:
      gateway:      ${{ steps.filter.outputs.gateway }}
      orchestrator: ${{ steps.filter.outputs.orchestrator }}
      rag:          ${{ steps.filter.outputs.rag }}
      memory:       ${{ steps.filter.outputs.memory }}
      executor:     ${{ steps.filter.outputs.executor }}
      evaluator:    ${{ steps.filter.outputs.evaluator }}
      telegram-bot: ${{ steps.filter.outputs.telegram-bot }}
      worker:       ${{ steps.filter.outputs.worker }}

    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            gateway:
              - 'services/gateway/**'
              - 'shared/contracts/**'
            orchestrator:
              - 'services/orchestrator/**'
              - 'shared/contracts/**'
            rag:
              - 'services/rag/**'
              - 'shared/contracts/**'
            memory:
              - 'services/memory/**'
              - 'shared/contracts/**'
            executor:
              - 'services/executor/**'
              - 'shared/contracts/**'
            evaluator:
              - 'services/evaluator/**'
              - 'shared/contracts/**'
            telegram-bot:
              - 'services/telegram-bot/**'
              - 'shared/contracts/**'
            worker:
              - 'services/worker/**'
              - 'shared/contracts/**'

  test-service:
    name: Test ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs[matrix.service] == 'true'

    strategy:
      fail-fast: false
      matrix:
        service:
          - gateway
          - orchestrator
          - rag
          - memory
          - executor
          - evaluator
          - telegram-bot
          - worker

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: services/${{ matrix.service }}/requirements.txt

      - name: Install dependencies
        working-directory: services/${{ matrix.service }}
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-cov httpx ruff pyright bandit

      # ── Gate 1: Lint (BLOCKING) ──────────────────────────
      - name: Lint — ruff
        working-directory: services/${{ matrix.service }}
        run: ruff check . --output-format=github

      - name: Format check — ruff format
        working-directory: services/${{ matrix.service }}
        run: ruff format --check .

      # ── Gate 2: Type Check (BLOCKING on PR to main) ──────
      - name: Type check — pyright
        working-directory: services/${{ matrix.service }}
        run: |
          if [ "${{ github.base_ref }}" = "main" ]; then
            pyright --pythonversion 3.12 .
          else
            pyright --pythonversion 3.12 . || echo "::warning::Type errors found (non-blocking on feature branch)"
          fi

      # ── Gate 3: Security Scan (BLOCKING) ─────────────────
      - name: Security scan — bandit
        working-directory: services/${{ matrix.service }}
        run: |
          bandit -r . \
            -x ./tests \
            -ll \
            --exit-zero-on-skips \
            -f json -o bandit-report.json || true
          # Fail only on HIGH severity
          bandit -r . -x ./tests -lll --exit-zero-on-skips

      # ── Gate 4: Unit Tests + Coverage (BLOCKING) ─────────
      - name: Unit tests + coverage
        working-directory: services/${{ matrix.service }}
        env:
          POSTGRES_URL: "postgresql://test:test@localhost:5432/test"
          VALKEY_URL: "redis://localhost:6379/0"
          QDRANT_URL: "http://localhost:6333"
          OPENROUTER_API_KEY: "test-key"
          GOOGLE_API_KEY: "test-key"
        run: |
          if [ -d "tests/unit" ] && [ "$(ls -A tests/unit)" ]; then
            pytest tests/unit/ \
              -v --tb=short \
              -m "unit" \
              --cov=. \
              --cov-report=xml:coverage.xml \
              --cov-report=term-missing \
              --cov-fail-under=70
          else
            echo "::warning::No unit tests found for ${{ matrix.service }} — add tests in tests/unit/"
          fi

      # ── Gate 5: Docker Build (BLOCKING) ──────────────────
      - name: Docker build
        run: |
          docker build \
            -f infra/docker/python.Dockerfile \
            -t bot-ai/${{ matrix.service }}:${{ github.sha }} \
            services/${{ matrix.service }}

      # ── Upload coverage report ────────────────────────────
      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: services/${{ matrix.service }}/coverage.xml
          flags: ${{ matrix.service }}
          fail_ci_if_error: false
