name: CI — Python Services

on:
  push:
    branches: [main, develop, "feat/**"]
    paths:
      - "services/gateway/**"
      - "services/orchestrator/**"
      - "services/rag/**"
      - "services/memory/**"
      - "services/executor/**"
      - "services/evaluator/**"
      - "services/telegram-bot/**"
      - "services/worker/**"
      - "shared/contracts/**"
      - ".github/workflows/ci-python-services.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "services/gateway/**"
      - "services/orchestrator/**"
      - "services/rag/**"
      - "services/memory/**"
      - "services/executor/**"
      - "services/evaluator/**"
      - "services/telegram-bot/**"
      - "services/worker/**"
      - "shared/contracts/**"

jobs:
  detect-changes:
    name: Detect changed services
    runs-on: ubuntu-latest
    outputs:
      gateway:      ${{ steps.filter.outputs.gateway }}
      orchestrator: ${{ steps.filter.outputs.orchestrator }}
      rag:          ${{ steps.filter.outputs.rag }}
      memory:       ${{ steps.filter.outputs.memory }}
      executor:     ${{ steps.filter.outputs.executor }}
      evaluator:    ${{ steps.filter.outputs.evaluator }}
      telegram-bot: ${{ steps.filter.outputs.telegram-bot }}
      worker:       ${{ steps.filter.outputs.worker }}

    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            gateway:
              - 'services/gateway/**'
              - 'shared/contracts/**'
            orchestrator:
              - 'services/orchestrator/**'
              - 'shared/contracts/**'
            rag:
              - 'services/rag/**'
              - 'shared/contracts/**'
            memory:
              - 'services/memory/**'
              - 'shared/contracts/**'
            executor:
              - 'services/executor/**'
              - 'shared/contracts/**'
            evaluator:
              - 'services/evaluator/**'
              - 'shared/contracts/**'
            telegram-bot:
              - 'services/telegram-bot/**'
              - 'shared/contracts/**'
            worker:
              - 'services/worker/**'
              - 'shared/contracts/**'

  # ─── Template job (reused per service) ───────────────────
  test-service:
    name: Test ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs[matrix.service] == 'true'

    strategy:
      fail-fast: false
      matrix:
        service:
          - gateway
          - orchestrator
          - rag
          - memory
          - executor
          - evaluator
          - telegram-bot
          - worker

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: services/${{ matrix.service }}/requirements.txt

      - name: Install dependencies
        working-directory: services/${{ matrix.service }}
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio httpx

      - name: Lint (ruff)
        working-directory: services/${{ matrix.service }}
        run: |
          pip install ruff
          ruff check . --output-format=github

      - name: Type check (pyright)
        working-directory: services/${{ matrix.service }}
        run: |
          pip install pyright
          pyright --pythonversion 3.12 . || true   # non-blocking ใน dev phase

      - name: Run tests
        working-directory: services/${{ matrix.service }}
        env:
          POSTGRES_URL: "postgresql://test:test@localhost:5432/test"
          VALKEY_URL: "redis://localhost:6379/0"
          QDRANT_URL: "http://localhost:6333"
          OPENROUTER_API_KEY: "test-key"
          GOOGLE_API_KEY: "test-key"
        run: |
          pytest tests/ -v --tb=short || echo "No tests yet"

      - name: Docker build (no push)
        run: |
          docker build \
            -f infra/docker/python.Dockerfile \
            -t bot-ai/${{ matrix.service }}:${{ github.sha }} \
            services/${{ matrix.service }}
