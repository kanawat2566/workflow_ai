name: Quality Gate — PR to main

# รันเฉพาะ PR → main เท่านั้น
# ทุก gate ต้องผ่านก่อน merge ได้
on:
  pull_request:
    branches: [main]

jobs:
  # ─── Gate 1: Contract Integrity ──────────────────────────
  contract-check:
    name: Gate 1 — Contract Integrity
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate all JSON schemas
        run: |
          pip install jsonschema
          python3 - <<'EOF'
          import json, sys
          from jsonschema import Draft7Validator

          schemas = [
            "shared/contracts/chunk_schema.json",
            "shared/contracts/retrieve_schema.json",
            "shared/contracts/sse_events.json",
            "shared/contracts/approval_pack.json",
            "shared/contracts/artifact_schema.json",
          ]
          ok = True
          for path in schemas:
            try:
              schema = json.load(open(path))
              Draft7Validator.check_schema(schema)
              print(f"✅ {path}")
            except Exception as e:
              print(f"❌ {path} — {e}")
              ok = False
          sys.exit(0 if ok else 1)
          EOF

      - name: Check no duplicate ports
        run: |
          python3 - <<'EOF'
          import json, sys
          data = json.load(open("shared/contracts/ports.json"))
          all_ports = list(data["services"].values()) + list(data["infrastructure"].values())
          dupes = [p for p in set(all_ports) if all_ports.count(p) > 1]
          if dupes:
            print(f"❌ Duplicate ports: {dupes}")
            sys.exit(1)
          print("✅ All ports unique")
          EOF

  # ─── Gate 2: No Secrets Leaked ───────────────────────────
  secret-scan:
    name: Gate 2 — No Secrets in Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # full history for secret scan

      - name: Scan for secrets (gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # ─── Gate 3: All CI must pass ────────────────────────────
  all-ci-passed:
    name: Gate 3 — All CI Jobs Passed
    runs-on: ubuntu-latest
    needs:
      - contract-check
      - secret-scan
    steps:
      - name: All gates passed
        run: echo "✅ All quality gates passed — ready to merge"

  # ─── Gate 4: Coverage Report Summary ─────────────────────
  coverage-summary:
    name: Gate 4 — Coverage Summary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Post coverage summary to PR
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## Quality Gate Summary

            | Gate | Status |
            |------|--------|
            | Contract Integrity | ✅ Passed |
            | Secret Scan | ✅ Passed |
            | Unit Tests (Python) | See CI — Python Services |
            | Unit Tests (.NET) | See CI — .NET Parser |
            | Unit Tests (Frontend) | See CI — Next.js Frontend |
            | Coverage Threshold | ≥ 70% required |

            > Merge to \`main\` requires all gates to pass.
            `;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
