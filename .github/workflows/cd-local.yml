name: CD â€” Deploy to Local Docker (Self-Hosted Runner)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      services:
        description: "Services to redeploy (comma-separated, or 'all')"
        required: false
        default: "all"

# à¸›à¹‰à¸­à¸‡à¸à¸±à¸™ deploy à¸‹à¹‰à¸­à¸™à¸à¸±à¸™
concurrency:
  group: deploy-local
  cancel-in-progress: false   # à¸£à¸­à¹ƒà¸«à¹‰ deploy à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²à¹€à¸ªà¸£à¹‡à¸ˆà¸à¹ˆà¸­à¸™

jobs:
  detect-changes:
    name: Detect changed services
    runs-on: self-hosted   # â† à¸§à¸´à¹ˆà¸‡à¸šà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ local
    outputs:
      parser-dotnet: ${{ steps.filter.outputs.parser-dotnet }}
      gateway:       ${{ steps.filter.outputs.gateway }}
      orchestrator:  ${{ steps.filter.outputs.orchestrator }}
      rag:           ${{ steps.filter.outputs.rag }}
      memory:        ${{ steps.filter.outputs.memory }}
      executor:      ${{ steps.filter.outputs.executor }}
      evaluator:     ${{ steps.filter.outputs.evaluator }}
      telegram-bot:  ${{ steps.filter.outputs.telegram-bot }}
      worker:        ${{ steps.filter.outputs.worker }}
      frontend:      ${{ steps.filter.outputs.frontend }}
      infra:         ${{ steps.filter.outputs.infra }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            parser-dotnet:
              - 'services/parser-dotnet/**'
              - 'infra/docker/dotnet.Dockerfile'
            gateway:
              - 'services/gateway/**'
              - 'infra/docker/python.Dockerfile'
            orchestrator:
              - 'services/orchestrator/**'
              - 'shared/contracts/**'
            rag:
              - 'services/rag/**'
              - 'shared/contracts/**'
            memory:
              - 'services/memory/**'
            executor:
              - 'services/executor/**'
              - 'shared/templates/**'
            evaluator:
              - 'services/evaluator/**'
            telegram-bot:
              - 'services/telegram-bot/**'
            worker:
              - 'services/worker/**'
            frontend:
              - 'frontend/**'
            infra:
              - 'docker-compose.yml'
              - 'infra/**'

  # â”€â”€â”€ Build & Restart changed services only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy changed services
    runs-on: self-hosted   # â† à¸§à¸´à¹ˆà¸‡à¸šà¸™à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡ local à¸—à¸µà¹ˆà¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ runner
    needs: detect-changes
    env:
      COMPOSE_FILE: docker-compose.yml
      PROJECT_DIR: ${{ github.workspace }}

    steps:
      - uses: actions/checkout@v4

      # â”€â”€ Pull .env à¸ˆà¸²à¸ local (à¹„à¸¡à¹ˆà¹€à¸à¹‡à¸šà¹ƒà¸™ git) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Check .env exists
        run: |
          if [ ! -f "$PROJECT_DIR/.env" ]; then
            echo "ERROR: .env not found at $PROJECT_DIR/.env"
            echo "Copy .env.example â†’ .env and fill in API keys"
            exit 1
          fi
          echo ".env found âœ“"

      # â”€â”€ Build + restart à¹€à¸‰à¸žà¸²à¸° service à¸—à¸µà¹ˆà¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy parser-dotnet
        if: needs.detect-changes.outputs.parser-dotnet == 'true' || github.event.inputs.services == 'all'
        working-directory: ${{ github.workspace }}
        run: |
          echo ">>> Rebuilding parser-dotnet..."
          docker compose build parser-dotnet
          docker compose up -d --no-deps parser-dotnet
          docker compose ps parser-dotnet

      - name: Deploy gateway
        if: needs.detect-changes.outputs.gateway == 'true' || github.event.inputs.services == 'all'
        working-directory: ${{ github.workspace }}
        run: |
          echo ">>> Rebuilding gateway..."
          docker compose build gateway
          docker compose up -d --no-deps gateway
          docker compose ps gateway

      - name: Deploy orchestrator
        if: needs.detect-changes.outputs.orchestrator == 'true' || github.event.inputs.services == 'all'
        working-directory: ${{ github.workspace }}
        run: |
          docker compose build orchestrator
          docker compose up -d --no-deps orchestrator

      - name: Deploy rag
        if: needs.detect-changes.outputs.rag == 'true' || github.event.inputs.services == 'all'
        working-directory: ${{ github.workspace }}
        run: |
          docker compose build rag
          docker compose up -d --no-deps rag

      - name: Deploy memory
        if: needs.detect-changes.outputs.memory == 'true' || github.event.inputs.services == 'all'
        working-directory: ${{ github.workspace }}
        run: |
          docker compose build memory
          docker compose up -d --no-deps memory

      - name: Deploy executor
        if: needs.detect-changes.outputs.executor == 'true' || github.event.inputs.services == 'all'
        working-directory: ${{ github.workspace }}
        run: |
          docker compose build executor
          docker compose up -d --no-deps executor

      - name: Deploy evaluator
        if: needs.detect-changes.outputs.evaluator == 'true' || github.event.inputs.services == 'all'
        working-directory: ${{ github.workspace }}
        run: |
          docker compose build evaluator
          docker compose up -d --no-deps evaluator

      - name: Deploy telegram-bot
        if: needs.detect-changes.outputs.telegram-bot == 'true' || github.event.inputs.services == 'all'
        working-directory: ${{ github.workspace }}
        run: |
          docker compose build telegram-bot
          docker compose up -d --no-deps telegram-bot

      - name: Deploy worker
        if: needs.detect-changes.outputs.worker == 'true' || github.event.inputs.services == 'all'
        working-directory: ${{ github.workspace }}
        run: |
          docker compose build worker
          docker compose up -d --no-deps worker

      - name: Deploy frontend
        if: needs.detect-changes.outputs.frontend == 'true' || github.event.inputs.services == 'all'
        working-directory: ${{ github.workspace }}
        run: |
          docker compose build frontend
          docker compose up -d --no-deps frontend

      # â”€â”€ Cleanup dangling images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cleanup old images
        working-directory: ${{ github.workspace }}
        run: docker image prune -f

      # â”€â”€ Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Health check all services
        working-directory: ${{ github.workspace }}
        run: |
          sleep 5
          echo "=== Container Status ==="
          docker compose ps

          echo ""
          echo "=== Health Checks ==="
          services=(gateway orchestrator rag memory executor evaluator)
          ports=(8000 8001 8002 8003 8004 8005)

          for i in "${!services[@]}"; do
            svc="${services[$i]}"
            port="${ports[$i]}"
            if curl -sf "http://localhost:${port}/health" > /dev/null 2>&1; then
              echo "âœ… ${svc}:${port} â€” OK"
            else
              echo "âš ï¸  ${svc}:${port} â€” not responding yet (may still be starting)"
            fi
          done

      # â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deployment summary
        run: |
          echo "## Deployment Complete ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Time: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services" >> $GITHUB_STEP_SUMMARY
          docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" >> $GITHUB_STEP_SUMMARY
